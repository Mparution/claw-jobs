name: CI/CD Pipeline

on:
  push:
    branches: [staging]
  pull_request:
    branches: [main, staging]

jobs:
  test-staging:
    name: Test Staging Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Removed cache - no package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Wait for Cloudflare deployment
        run: |
          echo "Waiting for Cloudflare Pages deployment..."
          sleep 120
          
      - name: Get staging URL
        id: staging-url
        run: |
          # Use the commit SHA preview URL format
          echo "url=https://${GITHUB_SHA:0:8}.claw-jobs.pages.dev" >> $GITHUB_OUTPUT

      - name: Health check - Homepage
        run: |
          # First try commit-based URL, fallback to staging branch URL
          for URL in "https://${GITHUB_SHA:0:8}.claw-jobs.pages.dev" "https://staging.claw-jobs.pages.dev"; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Homepage OK at $URL"
              echo "STAGING_URL=$URL" >> $GITHUB_ENV
              exit 0
            fi
            echo "Tried $URL - got $HTTP_STATUS"
          done
          echo "All staging URLs failed"
          exit 1

      - name: Health check - Stats API
        run: |
          RESPONSE=$(curl -s "$STAGING_URL/api/stats")
          if echo "$RESPONSE" | jq -e '.total_users' > /dev/null 2>&1; then
            echo "Stats API: OK"
            echo "$RESPONSE" | jq .
          else
            echo "Stats API failed: $RESPONSE"
            exit 1
          fi

      - name: Health check - Gigs API
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL/api/gigs")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Gigs API failed with status $HTTP_STATUS"
            exit 1
          fi
          echo "Gigs API: OK"

  deploy-production:
    name: Deploy to Production
    needs: test-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge staging to main
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git fetch origin main
          git checkout main
          git merge origin/staging -m "chore: auto-deploy from staging [skip ci]"
          git push origin main

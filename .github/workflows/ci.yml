name: CI/CD Pipeline

on:
  push:
    branches: [staging, main]
  pull_request:
    branches: [main, staging]

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint || true  # Don't fail on lint warnings
      - name: Type Check
        run: npx tsc --noEmit || true  # Report but don't fail
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://example.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.placeholder

  test-deployment:
    name: Test Live Deployment
    runs-on: ubuntu-latest
    # Only run after Cloudflare has time to deploy
    if: github.event_name == 'push'
    
    steps:
      - name: Determine environment URL
        id: env-url
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "url=https://claw-jobs.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://staging.claw-jobs.pages.dev" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Cloudflare deployment
        run: |
          echo "Waiting for deployment at ${{ steps.env-url.outputs.url }}..."
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.env-url.outputs.url }}/api/health" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Site is live!"
              exit 0
            fi
            echo "Attempt $i/30: HTTP $HTTP_CODE, waiting 10s..."
            sleep 10
          done
          echo "⚠️ Deployment check timed out (site may still be deploying)"
          exit 0  # Don't fail - Cloudflare deploys independently

      - name: Health check
        run: |
          curl -sf "${{ steps.env-url.outputs.url }}/api/health" | jq . || echo "Health check skipped"

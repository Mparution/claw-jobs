name: CI/CD Pipeline

on:
  push:
    branches: [staging, main]
  pull_request:
    branches: [main, staging]

jobs:
  test:
    name: Test Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Wait for Cloudflare deployment
        run: |
          echo "Waiting for Cloudflare Pages deployment..."
          sleep 120
          
      - name: Determine environment URL
        id: env-url
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "url=https://claw-jobs.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://staging.claw-jobs.pages.dev" >> $GITHUB_OUTPUT
          fi

      - name: Health check - Homepage
        run: |
          URL="${{ steps.env-url.outputs.url }}"
          # Try commit-based URL first for staging
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            COMMIT_URL="https://${GITHUB_SHA:0:8}.claw-jobs.pages.dev"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$COMMIT_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Homepage OK at $COMMIT_URL"
              echo "DEPLOY_URL=$COMMIT_URL" >> $GITHUB_ENV
              exit 0
            fi
          fi
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" 2>/dev/null || echo "000")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Homepage OK at $URL"
            echo "DEPLOY_URL=$URL" >> $GITHUB_ENV
          else
            echo "Homepage check failed with status $HTTP_STATUS"
            exit 1
          fi

      - name: Health check - Stats API
        run: |
          RESPONSE=$(curl -s "$DEPLOY_URL/api/stats")
          if echo "$RESPONSE" | jq -e '.total_users' > /dev/null 2>&1; then
            echo "Stats API: OK"
            echo "$RESPONSE" | jq .
          else
            echo "Stats API: $RESPONSE"
            # Don't fail - staging might not have full DB access
            echo "Warning: Stats API may not be fully configured"
          fi

      - name: Health check - Gigs API
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/api/gigs")
          echo "Gigs API status: $HTTP_STATUS"
